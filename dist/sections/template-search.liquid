<link rel="stylesheet" href="{{ 'facet.css' | asset_url }}">
{% paginate search.results by 10 %}
  <div class="page-width-desktop flex flex-wrap pb-5 lg:pt-12 lg:pb-20" data-id="{{ section.id }}" id="ProductGridContainer">
    {% if search.results.size > 0 %}
      {% render 'facet', results: search %}
    {% endif %}
    <div class="w-full lg:max-w-3/4 transition-all duration-500 lg:ml-auto" data-total-pages="{{ paginate.pages }}" data-pagination="{{ products_per_page }}" data-current-page="{{ paginate.current_page }}" id="product-grid">
      {% if search.results.size > 0 %}
        <div class="facet-mobile flex items-center justify-between mt-6 mb-4 lg:my-4 px-4 md:px-7.5 md:-mx-7.5 lg:mx-0 lg:px-0 lg:mt-0 sticky z-10 top-0 lg:static transition-all duration-200 bg-background">
          <div class="flex flex-col lg:w-1/4 lg:flex-row lg:items-center lg:justify-between gap-4 lg:gap-1">
            <toggle-filter class="block lg:hidden lg:opacity-0 lg:invisible transition-all duration-500">
              <button class="flex items-center capitalize whitespace-nowrap lg:normal-case text-base font-semibold lg:font-normal leading-none text-primary bg-[#F6F6F6] lg:bg-transparent py-2 px-4 lg:p-0 rounded-md lg:text-primary font-heading lg:font-body cursor-pointer gap-2">
                {% render 'icon-filter' , class: 'w-5 h-5 lg:w-4 lg:h-4' %}
                <span class="block lg:hidden">{{- 'products.facets.filter' | t -}}</span>
                <span class="hidden lg:block">{{- 'products.facets.show_filter' | t -}}</span>
              </button>
            </toggle-filter>
            <div id="ProductCount" class="viewing-currently-product text-sm text-primary order-2 whitespace-nowrap hidden lg:block">
              {% liquid
                assign products_count = paginate.current_page | times: section.settings.products_per_page
                if products_count > paginate.items
                  assign products_count = paginate.items
                endif
              %}
              {{ 'sections.collection_template.current_view_count_html' | t: all_products_count: paginate.items, products_count: products_count }}
            </div>
          </div>
          <facet-filters-form class="flex items-center justify-end gap-4 sort-by" id="sortby-wrapper">
            <form id="FacetSortForm">
              <div class="flex items-center gap-2">
                <span class="text-primary text-base font-light hidden lg:block">{{ 'products.facets.sort_by_label' | t }}</span>
                {%- assign sort_by = search.sort_by | default: search.default_sort_by -%}
                <select name="sort_by" class="hidden opacity-0 invisible absolute -z-30" id="SortBy" aria-describedby="a11y-refresh-page-message">
                  {%- for option in search.sort_options -%}
                    {% if option.value != 'title-ascending' and option.value != 'title-descending' %}
                      <option value="{{ option.value | escape }}" {% if option.value == sort_by %} selected="selected"{% endif %}></option>
                    {% endif %}
                  {%- endfor -%}
                </select>
                <accordion-toggle class="inline-block relative cursor-pointer clickout-accordion">
                  <div class="summary flex items-center gap-2.5">
                    {%- for option in search.sort_options -%}
                      {% if option.value == sort_by %}
                        <span class="inline-block text-sm lg:text-base text-primary font-medium" data-value="{{ option.value | escape }}">
                          {% if option.value == "manual" %}
                            {{ 'products.facets.sort_by.manual' | t }}
                          {% elsif option.value == "best-selling" %}
                            {{ 'products.facets.sort_by.best_selling' | t }}
                          {% elsif option.value == "price-ascending" %}
                            {{ 'products.facets.sort_by.price_ascending' | t }}
                          {% elsif option.value == "price-descending" %}
                            {{ 'products.facets.sort_by.price_descending' | t }}
                          {% elsif option.value == "created-ascending" %}
                            {{ 'products.facets.sort_by.created_ascending' | t }}
                          {% elsif option.value == "created-descending" %}
                            {{ 'products.facets.sort_by.created_descending' | t }}
                          {% else %}
                            {{ option.name | escape }}
                          {% endif %}
                        </span>
                      {% endif %}
                    {%- endfor -%}
                    {% render 'icon-down', class: 'w-4.5 h-4.5 text-primary' %}
                  </div>
                  <div class="shadow-megamenu dropitem w-max details absolute z-10 right-0 top-full rounded-lg bg-background py-3 pl-4 pr-3 opacity-0 invisible">
                    <ul class="max-h-60 w-full overflow-auto scroll-thin scroll-brighter">
                      {%- for option in search.sort_options -%}
                        {% if option.value != 'title-ascending' and option.value != 'title-descending' %}
                          <li class="cursor-pointer transition-all text-primary text-sm lg:text-base font-light leading-normal p-2 mr-2 rounded hover:bg-[#f4f4f4]{% if option.value == sort_by %} active{% endif %}" data-value="{{ option.value | escape }}">
                            {% if option.value == "manual" %}
                              {{ 'products.facets.sort_by.manual' | t }}
                            {% elsif option.value == "best-selling" %}
                              {{ 'products.facets.sort_by.best_selling' | t }}
                            {% elsif option.value == "price-ascending" %}
                              {{ 'products.facets.sort_by.price_ascending' | t }}
                            {% elsif option.value == "price-descending" %}
                              {{ 'products.facets.sort_by.price_descending' | t }}
                            {% elsif option.value == "created-ascending" %}
                              {{ 'products.facets.sort_by.created_ascending' | t }}
                            {% elsif option.value == "created-descending" %}
                              {{ 'products.facets.sort_by.created_descending' | t }}
                            {% else %}
                              {{ option.name | escape }}
                            {% endif %}
                          </li>
                        {% endif %}
                      {%- endfor -%}
                    </ul>
                  </div>
                </accordion-toggle>
              </div>
              {% if search.current_vendor or search.current_type %}
                <input type="hidden" name="q" value="{{ search.current_vendor }}{{ search.current_type }}">
              {% endif %}
              {%- if search.terms -%}
                <input type="hidden" name="q" value="{{ search.terms | escape }}">
                <input name="options[prefix]" type="hidden" value="last">
              {%- endif -%}
            </form>
          </facet-filters-form>
        </div>
      {% endif %}
      <div id="ProductCountMobile" class="viewing-currently-product text-sm px-4 md:px-0 mb-5 text-primary order-2 whitespace-nowrap hidden">
        {% liquid
          assign products_count = paginate.current_page | times: section.settings.products_per_page
          if products_count > paginate.items
            assign products_count = paginate.items
          endif
        %}
        {{ 'sections.collection_template.current_view_count_html' | t: all_products_count: paginate.items, products_count: products_count }}
      </div>
      {%- if search.performed -%}
        <div id="main-collection-product" class="grid grid-cols-2 md:grid-cols-3 gap-x-2 gap-y-8 md:gap-x-4 md:gap-y-10 transition-all duration-500 px-2 md:px-0">
          {% assign listIncludeProduct = '' %}
          {% if search.results.size > 0 %}
            {% for product in search.results %}
              {% assign lastKey = product.handle | split: '-' | last %}
              {% unless listIncludeProduct contains lastKey %}
                {%- render 'product-card', product: product -%}
                {% assign listIncludeProduct = listIncludeProduct | append: lastKey | append: ',' %}
              {% endunless %}
            {% endfor %}
          {% endif %}
        </div>
      {%- endif -%}
      <div class="flex flex-col justify-center items-center gap-4 lg:gap-6 mt-8 lg:mt-12{% if paginate.pages <= 1 %} hidden{% endif %}" id="PaginationInfor">
        <div id="ProductCountDesktop" class="viewing-currently-product">
          {% liquid
            assign products_count = paginate.current_page | times: section.settings.products_per_page
            if products_count > paginate.items
              assign products_count = paginate.items
            endif
          %}
          <span class="text-sm text-primary font-light">{{ 'sections.collection_template.current_view_html' | t: all_products_count: paginate.items, products_count: products_count }}</span>
          <div class="max-w-[194px] rounded-2xl{% unless settings.country == 'FR' %} bg-[#F1F1F1]{% else %} bg-primary{% endunless %} h-1 relative overflow-hidden mt-3">
                <div class="rounded-l-2xl absolute top-0 left-0 h-1 w-full bg-secondary !block rounded-2xl" style="max-width: {{ products_count | divided_by: 1.0 | divided_by: paginate.items |  times: 100 }}%"></div>
          </div>
        </div>
        <collection-loadmore data-click-loadmore="false" class="block text-center">
          <span data-href="{{ paginate.next.url }}" class="btn btn-2 border !text-sm !leading-none load-more_btn py-3.5 px-6">{{- 'sections.collection_template.load_more' | t -}}</span>
        </collection-loadmore>
      </div>
    </div>
  </div>
{% endpaginate %}
{% capture facet %}{{ 'facet.js' | asset_url }}{% endcapture %}
{% render 'atom_script', src: facet, priority: 'normal', type: "defer" %}

<script defer>
  let term = '{{ search.terms }}';
  let list = JSON.parse(localStorage.getItem('recentSearch')) || [];
  if (localStorage.getItem('recentSearch')) {
    if(!list.includes(term)) {
      list.unshift(term);
      if(list.length > 3) {
        list.pop();
      }
    }
    localStorage.setItem('recentSearch', JSON.stringify(list));
  } else {
    list.unshift(term);
    localStorage.setItem('recentSearch', JSON.stringify(list));
  }
</script>

{% schema %}
  {
    "name": "template-search",
    "settings": [
      {
        "type": "range",
        "id": "products_per_page",
        "min": 8,
        "max": 50,
        "step": 1,
        "default": 20,
        "label": "t:sections.main-collection-product-grid.settings.products_per_page.label"
      }
    ]
  }
{% endschema %}