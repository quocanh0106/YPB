<link rel="stylesheet" href="{{ 'facet.css' | asset_url }}">

{% paginate collection.products by section.settings.products_per_page %}
  <div class="page-width-desktop flex flex-wrap pb-5 lg:pt-12 lg:pb-20" data-id="{{ section.id }}" id="ProductGridContainer">
    {% render 'facet', results: collection %}
    <div class="w-full lg:max-w-3/4 transition-all duration-500 lg:ml-auto" data-total-pages="{{ paginate.pages }}" data-pagination="{{ products_per_page }}" data-current-page="{{ paginate.current_page }}" id="product-grid">
      <div class="facet-mobile flex items-center justify-between mt-6 mb-4 lg:my-4 px-4 md:px-7.5 md:-mx-7.5 lg:mx-0 lg:px-0 lg:mt-0 sticky z-10 top-0 lg:static transition-all duration-200 bg-background">
        <div class="flex flex-col lg:w-1/4 lg:flex-row lg:items-center lg:justify-between gap-4 lg:gap-1">
          <toggle-filter class="block lg:hidden lg:opacity-0 lg:invisible transition-all duration-500">
            <button class="flex items-center capitalize whitespace-nowrap lg:normal-case text-base font-semibold lg:font-normal leading-none text-primary bg-[#F6F6F6] lg:bg-transparent py-2 px-4 lg:p-0 rounded-md lg:text-primary font-heading lg:font-body cursor-pointer gap-2">
              {% render 'icon-filter', class: 'w-5 h-5 lg:w-4 lg:h-4' %}
              <span class="block lg:hidden">{{- 'products.facets.filter' | t -}}</span>
              <span class="hidden lg:block">{{- 'products.facets.show_filter' | t -}}</span>
            </button>
          </toggle-filter>
          <div id="ProductCount" class="viewing-currently-product text-sm text-primary order-2 whitespace-nowrap hidden lg:block">
            {% liquid
              assign products_count = paginate.current_page | times: section.settings.products_per_page
              if products_count > paginate.items
                assign products_count = paginate.items
              endif
            %}
            {{ 'sections.collection_template.current_view_count_html' | t: all_products_count: paginate.items, products_count: products_count }}
          </div>
        </div>
        <facet-filters-form class="flex items-center justify-end gap-4 sort-by" id="sortby-wrapper">
          <form id="FacetSortForm">
            <div class="flex items-center gap-2 js-filter" data-index="sort-by">
              <span class="text-primary text-base font-light hidden lg:block">{{ 'products.facets.sort_by_label' | t }}</span>
              {%- assign sort_by = collection.sort_by | default: collection.default_sort_by -%}
              <select name="sort_by" class="hidden opacity-0 invisible absolute -z-30" id="SortBy" aria-describedby="a11y-refresh-page-message">
                {%- for option in collection.sort_options -%}
                  <option value="{{ option.value | escape }}" {% if option.value == sort_by %} selected="selected"{% endif %}></option>
                {%- endfor -%}
              </select>
              <accordion-toggle class="inline-block relative cursor-pointer clickout-accordion">
                <div class="summary flex items-center gap-2.5">
                  {%- for option in collection.sort_options -%}
                    {% if option.value == sort_by %}
                      <span class="inline-block text-sm lg:text-base text-primary font-medium" data-value="{{ option.value | escape }}">
                        {% if option.value == "manual" %}
                          {{ 'products.facets.sort_by.manual' | t }}
                        {% elsif option.value == "best-selling" %}
                          {{ 'products.facets.sort_by.best_selling' | t }}
                        {% elsif option.value == "price-ascending" %}
                          {{ 'products.facets.sort_by.price_ascending' | t }}
                        {% elsif option.value == "price-descending" %}
                          {{ 'products.facets.sort_by.price_descending' | t }}
                        {% elsif option.value == "created-ascending" %}
                          {{ 'products.facets.sort_by.created_ascending' | t }}
                        {% elsif option.value == "created-descending" %}
                          {{ 'products.facets.sort_by.created_descending' | t }}
                        {% elsif option.value == "title-ascending" %}
                          {{ 'products.facets.sort_by.title_ascending' | t }}
                        {% elsif option.value == "title-descending" %}
                          {{ 'products.facets.sort_by.title_descending' | t }}
                        {% else %}
                          {{ option.name | escape }}
                        {% endif %}
                      </span>
                    {% endif %}
                  {%- endfor -%}
                  {% render 'icon-down', class: 'w-4.5 h-4.5 text-primary' %}
                </div>
                <div class="shadow-megamenu dropitem w-max details absolute z-10 right-0 top-full rounded-lg bg-background py-3 pl-4 pr-3 opacity-0 invisible min-w-[174px]">
                  <ul class="max-h-60 w-full overflow-auto scroll-thin scroll-brighter">
                    {% if collection.handle != 'all' %}
                      {%- for option in collection.sort_options -%}
                        {% if option.value != 'title-ascending' and option.value != 'title-descending' %}
                          <li class="cursor-pointer transition-all text-primary text-sm lg:text-base font-light leading-normal p-2 mr-2 rounded hover:bg-[#f4f4f4]{% if option.value == sort_by %} active{% endif %}" data-value="{{ option.value | escape }}">
                            {% if option.value == "manual" %}
                              {{ 'products.facets.sort_by.manual' | t }}
                            {% elsif option.value == "best-selling" %}
                              {{ 'products.facets.sort_by.best_selling' | t }}
                            {% elsif option.value == "price-ascending" %}
                              {{ 'products.facets.sort_by.price_ascending' | t }}
                            {% elsif option.value == "price-descending" %}
                              {{ 'products.facets.sort_by.price_descending' | t }}
                            {% elsif option.value == "created-ascending" %}
                              {{ 'products.facets.sort_by.created_ascending' | t }}
                            {% elsif option.value == "created-descending" %}
                              {{ 'products.facets.sort_by.created_descending' | t }}
                            {% elsif option.value == "title-ascending" %}
                              {{ 'products.facets.sort_by.title_ascending' | t }}
                            {% elsif option.value == "title-descending" %}
                              {{ 'products.facets.sort_by.title_descending' | t }}
                            {% else %}
                              {{ option.name | escape }}
                            {% endif %}
                          </li>
                        {% endif %}
                      {%- endfor -%}
                    {% else %}
                      {%- for option in collection.sort_options -%}
                        <li class="cursor-pointer transition-all text-primary text-sm lg:text-base font-light leading-normal p-2 mr-2 rounded hover:bg-[#f4f4f4]{% if option.value == sort_by %} active{% endif %}" data-value="{{ option.value | escape }}">
                          {% if option.value == "manual" %}
                            {{ 'products.facets.sort_by.manual' | t }}
                          {% elsif option.value == "best-selling" %}
                            {{ 'products.facets.sort_by.best_selling' | t }}
                          {% elsif option.value == "price-ascending" %}
                            {{ 'products.facets.sort_by.price_ascending' | t }}
                          {% elsif option.value == "price-descending" %}
                            {{ 'products.facets.sort_by.price_descending' | t }}
                          {% elsif option.value == "created-ascending" %}
                            {{ 'products.facets.sort_by.created_ascending' | t }}
                          {% elsif option.value == "created-descending" %}
                            {{ 'products.facets.sort_by.created_descending' | t }}
                          {% elsif option.value == "title-ascending" %}
                            {{ 'products.facets.sort_by.title_ascending' | t }}
                          {% elsif option.value == "title-descending" %}
                            {{ 'products.facets.sort_by.title_descending' | t }}
                          {% else %}
                            {{ option.name | escape }}
                          {% endif %}
                        </li>
                      {%- endfor -%}
                    {% endif %}
                  </ul>
                </div>
              </accordion-toggle>
            </div>
            {% if collection.current_vendor or collection.current_type %}
              <input type="hidden" name="q" value="{{ collection.current_vendor }}{{ collection.current_type }}">
            {% endif %}
            {%- if collection.terms -%}
              <input type="hidden" name="q" value="{{ collection.terms | escape }}">
              <input name="options[prefix]" type="hidden" value="last">
            {%- endif -%}
          </form>
        </facet-filters-form>
      </div>
      <div id="ProductCountMobile" class="viewing-currently-product text-sm px-4 md:px-0 mb-8 lg:mb-5 text-primary order-2 whitespace-nowrap lg:hidden">
        {% liquid
          assign products_count = paginate.current_page | times: section.settings.products_per_page
          if products_count > paginate.items
            assign products_count = paginate.items
          endif
        %}
        {{ 'sections.collection_template.current_view_count_html' | t: all_products_count: paginate.items, products_count: products_count }}
      </div>
      <div id="main-collection-product" class="grid grid-cols-2 md:grid-cols-3 gap-x-2 gap-y-8 md:gap-x-4 md:gap-y-10 transition-all duration-500 px-2 md:px-0">
        {% assign listIncludeProduct = '' %}
        {% assign count = 0 %}
        {% if collection.products.size > 0 %}
          {% for product in collection.products %}
            {% assign lastKey = product.handle | split: '-' | last %}
            {% if paginate.current_page == 1 and forloop.index == 6 and section.settings.poster != blank %}
              {% if section.settings.poster_url %}<a href="{{  section.settings.poster_url }}" {% else %}<div {% endif %}class="relative block group overflow-hidden rounded-lg h-full" title="{{  section.settings.posterurl | split: "/" | last | replace: "-", " " | split: "." | first }}">
                  <img srcset="{%- if section.settings.poster.width >= 165 -%}{{ section.settings.poster | image_url: width: 165 }} 165w,{%- endif -%}
                               {%- if section.settings.poster.width >= 360 -%}{{ section.settings.poster | image_url: width: 360 }} 360w,{%- endif -%}
                               {%- if section.settings.poster.width >= 533 -%}{{ section.settings.poster | image_url: width: 533 }} 533w,{%- endif -%}
                               {%- if section.settings.poster.width >= 720 -%}{{ section.settings.poster | image_url: width: 720 }} 720w,{%- endif -%}
                               {%- if section.settings.poster.width >= 940 -%}{{ section.settings.poster | image_url: width: 940 }} 940w,{%- endif -%}
                               {%- if section.settings.poster.width >= 1066 -%}{{ section.settings.poster | image_url: width: 1066 }} 1066w,{%- endif -%}"
                      src="{{ section.settings.poster | image_url: width: 533 }}"
                      sizes="(min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 130 | divided_by: 4 }}px, (min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
                      alt="{{ section.settings.poster | split: "/" | last | replace: "-", " " | split: "." | first }}"
                      loading="lazy"
                      class="block group-hover:scale-105 transition-all duration-300 w-full h-full object-cover object-top bg-image-placeholder bg-no-repeat bg-cover bg-center text-transparent"
                      width="512"
                      height="{{ 512 | divided_by: section.settings.poster.aspect_ratio }}"
                  >
              </{% if section.settings.poster_url %}a{% else %}div{% endif %}>
            {% endif %}
                {% unless listIncludeProduct contains lastKey %}
                  {% assign count = count | plus: 1 %}
                  {% if count > 4 %}
                    {% assign lazy_load = 'lazy' %}
                  {% else %}
                    {% assign lazy_load = 'eager' %}
                  {% endif %}
                  {%- render 'product-card', product: product, lazy_load: lazy_load -%}
                  {% assign listIncludeProduct = listIncludeProduct | append: lastKey | append: ',' %}
                {% endunless %}
              {% endfor %}
        {% else %}
          <div class="col-span-2 md:col-span-3 rounded-2xl bg-background py-3 lg:p-10 lg:shadow-megamenu">
            <div class="text-center p-6 lg:py-20 rounded-2xl {% if settings.country == 'DE' or settings.country == 'UK' %}bg-secondary{% else %}bg-background{% endif %} max-w-full mx-auto">
              {% render 'icon-predictive-search', class: 'w-20 h-20 lg:w-32 lg:h-32 mb-3 mx-auto block text-center text-primary' %}
              <span class="block text-center text-primary text-h5 lg:text-h4 mb-1 font-heading">{{ 'products.facets.empty_heading' | t }}</span>
              <span class="block text-center text-primary text-sm leading-5 lg:text-base lg:leading-6 font-light max-w-[263px] lg:max-w-[386px] mx-auto mb-4 lg:mb-6">{{ 'products.facets.empty_description' | t }}</span>
              <a href="{{ collection.url }}" title="{{ 'products.facets.clear_all' | t }}"  class="block mx-auto w-fit btn btn-2 px-6 lg:px-8 py-3.5 text-sm leading-none uppercase lg:text-base lg:leading-none !font-heading !font-bold">
                {{ 'products.facets.clear_all' | t }}
              </a>
            </div>
          </div>
        {% endif %}
      </div>
      <div class="flex flex-col justify-center items-center gap-4 lg:gap-6 mt-8 lg:mt-12{% if paginate.pages <= 1 %} hidden{% endif %}" id="PaginationInfor">
        <div id="ProductCountDesktop" class="viewing-currently-product">
          {% liquid
            assign products_count = paginate.current_page | times: section.settings.products_per_page
            if products_count > paginate.items
              assign products_count = paginate.items
            endif
          %}
          <span class="text-sm text-primary font-light">{{ 'sections.collection_template.current_view_html' | t: all_products_count: paginate.items, products_count: products_count }}</span>
          <div class="max-w-[194px] mx-auto rounded-2xl{% if settings.country == 'FR' %} bg-primary{% elsif settings.country == 'DE' %} bg-primary{% else %} bg-[#F1F1F1]{% endif %} h-1 relative overflow-hidden mt-3">
            <div class="rounded-l-2xl absolute top-0 left-0 h-1 w-full bg-secondary !block rounded-2xl" style="max-width: {{ products_count | divided_by: 1.0 | divided_by: paginate.items |  times: 100 }}%"></div>
          </div>
        </div>
        <collection-loadmore data-click-loadmore="false" class="block text-center">
          <span data-href="{{ paginate.next.url }}" class="btn btn-2 border !text-sm !leading-none load-more_btn py-3.5 px-6">{{- 'sections.collection_template.load_more' | t -}}</span>
        </collection-loadmore>
      </div>
    </div>
  </div>
{% endpaginate %}

{% capture facet %}{{ 'facet.js' | asset_url }}{% endcapture %}
{% render 'atom_script', src: facet, priority: 'normal', type: "defer" %}

{% schema %}
  {
    "name": "Collection",
    "settings": [
      {
        "type": "header",
        "content": "Poster"
      },
      {
        "type": "image_picker",
        "id": "poster",
        "label": "Poster"
      },
      {
        "type": "url",
        "id": "poster_url",
        "label": "Poster url"
      },
      {
        "type": "range",
        "id": "products_per_page",
        "min": 8,
        "max": 50,
        "step": 1,
        "default": 20,
        "label": "t:sections.main-collection-product-grid.settings.products_per_page.label"
      }
    ]
  }
{% endschema %}